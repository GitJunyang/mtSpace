package com.moutum.mtplatform.application.controller;

import java.util.ArrayList;
import java.util.List;

import org.activiti.engine.HistoryService;
import org.activiti.engine.TaskService;
import org.activiti.engine.history.HistoricTaskInstance;
import org.activiti.engine.task.Comment;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.baomidou.mybatisplus.mapper.EntityWrapper;
import com.baomidou.mybatisplus.plugins.Page;
import com.moutum.mtplatform.activiti.vo.CommentVo;
import com.moutum.mtplatform.application.model.TVacation;
import com.moutum.mtplatform.application.service.TVacationService;
import com.moutum.mtplatform.common.base.BaseController;
import com.moutum.mtplatform.common.operlog.SysLog;
import com.moutum.mtplatform.common.shiro.ShiroUser;
import com.moutum.mtplatform.common.utils.DateUtils;
import com.moutum.mtplatform.common.utils.PageInfo;
import com.moutum.mtplatform.system.model.SysUser;
import com.moutum.mtplatform.system.service.SysUserService;

/**
 * <p>
 * 请假表  前端控制器
 * </p>
 * @author junyang.liu
 */
@Controller
@RequestMapping("/tVacation")
public class TVacationController extends BaseController{
    
    @Autowired
	private TaskService taskService;
	@Autowired 
	private TVacationService tVacationService;
	@Autowired
    private SysUserService sysUserService;
	@Autowired
	private HistoryService historyService;
	
	
    /**
     * 请假列表页面
     * @return
     */
    @GetMapping("/manager")
    public String manager() {
        return "application/tVacation";
    }


    /**
     * 请假列表
     * @param tVacation
     * @param page
     * @param rows
     * @param sort
     * @param order
     * @return
     */
    @SysLog
    @PostMapping("/dataGrid")
    @ResponseBody
    public PageInfo dataGrid(TVacation tVacation, Integer page, Integer rows, String sort,String order) {
        EntityWrapper<TVacation> ew = new EntityWrapper<TVacation>();
        ShiroUser user= getShiroUser();
        tVacation.setUserId(user.getId());
        ew.setEntity(tVacation);
        Page<TVacation> pages = getPage(page, rows, sort, order);
        pages = tVacationService.selectPage(pages,ew);
        return pageToPageInfo(pages);
    }
    
    /**
     * 添加页面
     * @return
     */
    @GetMapping("/addPage")
    public String addPage() {
        return "application/tVacationAdd";
    }

    /**
     * 添加
     * @param 
     * @return
     */
    @PostMapping("/add")
    @ResponseBody
    public Object add(TVacation tVacation) {
        tVacationService.startVacation(tVacation);
    	return renderSuccess("申请成功！");
    }
    
    /**
     * 查看审批进度
     * @return
     */
    @GetMapping("/tVacationGetCommentsPage")
    public String tVacationGetCommentsPage(Model model, String id) {
		TVacation vacation= tVacationService.selectById(id);
		List<CommentVo> comments = new ArrayList<CommentVo>();
		List<Comment> commentList= taskService.getProcessInstanceComments(vacation.getProcInstId());
		for(Comment comment : commentList){
			CommentVo vo = new CommentVo();
			SysUser user= sysUserService.selectById(comment.getUserId());
			vo.setCommentUser(user.getUserName());
			vo.setCommentTime(DateUtils.formatDateToString(comment.getTime()));
			vo.setCommentContent(comment.getFullMessage());
			HistoricTaskInstance his= historyService.createHistoricTaskInstanceQuery().taskId(comment.getTaskId()).singleResult();
			vo.setCommentTask(his.getName());
			comments.add(vo);
		}
		model.addAttribute("comments", comments);
        return "application/tVacationGetComments";
    }
    
    
    
}
